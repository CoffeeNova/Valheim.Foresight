name: Build and Package

on:
  push:
    branches:
      - main
      - ci/cd
    tags: [ 'v*' ]
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      publish_package:
        description: 'Publish package'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  
jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.gitversion.outputs.majorMinorPatch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET Framework 4.8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
        with:
          nuget-version: 'latest'

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.1.11
        with:
          versionSpec: '6.0.x'

      - name: Run GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.1.11
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display version
        shell: pwsh
        run: |
          echo "NuGetVersion: $env:GitVersion_SemVer"
          echo "SemVer: $env:GitVersion_SemVer"
          echo "FullSemVer: $env:GitVersion_FullSemVer"

      - name: Update project version
        shell: pwsh
        run: |
          $csprojPath = "src/Valheim.Foresight/Valheim.Foresight.csproj"
          [xml]$csproj = Get-Content $csprojPath
          $propertyGroup = $csproj.Project.PropertyGroup | Where-Object { $_.Version }
          if ($propertyGroup) {
              $propertyGroup.Version = "$env:GitVersion_MajorMinorPatch"
              $propertyGroup.AssemblyVersion = "$env:GitVersion_AssemblySemVer"
              $propertyGroup.FileVersion = "$env:GitVersion_AssemblySemFileVer"
              $propertyGroup.InformationalVersion = "$env:GitVersion_InformationalVersion"
              
              $csproj.Save($csprojPath)
              Write-Host "Updated version to $env:GitVersion_MajorMinorPatch"
          }

      - name: Restore NuGet packages
        shell: pwsh
        run: |
          nuget restore src/Valheim.Foresight/Valheim.Foresight.csproj -PackagesDirectory src/packages

      - name: Build Release
        shell: pwsh
        run: |
          msbuild src/Valheim.Foresight/Valheim.Foresight.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:GitVersion_MajorMinorPatch=$env:GitVersion_MajorMinorPatch `
            /p:GitVersion_AssemblySemVer=$env:GitVersion_AssemblySemVer `
            /p:GitVersion_AssemblySemFileVer=$env:GitVersion_AssemblySemFileVer `
            /p:GitVersion_InformationalVersion=$env:GitVersion_InformationalVersion

      - name: Run unit tests
        shell: pwsh
        run: |
          if (Test-Path "tests/Valheim.Foresight.Unit Tests/Valheim.Foresight.Unit Tests.csproj") {
              dotnet test tests/Valheim.Foresight.Unit Tests/Valheim.Foresight.Unit Tests.csproj --configuration Release --no-build
          } else {
              Write-Host "No test project found, skipping tests"
          }

      - name: Copy screenshots
        shell: pwsh
        run: |
          $sourceDir = "gallery/screenshots"
          $destDir = "gallery/thunderstore/screenshots"
          if (Test-Path $sourceDir) {
              New-Item -ItemType Directory -Force -Path $destDir
              Copy-Item -Path "$sourceDir/*" -Destination $destDir -Recurse -Force
              Write-Host "Copied screenshots from $sourceDir to $destDir"
          } else {
              Write-Host "Source directory $sourceDir does not exist"
          }

      - name: Prepare Thunderstore package
        shell: pwsh
        run: |
          $thunderstoreDir = "gallery/thunderstore"
          $releaseDir = "src/Valheim.Foresight/bin/Release"

          if (Test-Path "$releaseDir/Valheim.Foresight.dll") {
              $pluginsDir = "$thunderstoreDir/BepInEx/plugins"
              New-Item -ItemType Directory -Force -Path $pluginsDir | Out-Null
              Copy-Item -Path "$releaseDir/Valheim.Foresight.dll" -Destination $pluginsDir -Force
              Write-Host "Copied DLL to Thunderstore directory"
          }
          
          $manifestPath = "$thunderstoreDir/manifest.json"
          if (Test-Path $manifestPath) {
              $manifest = Get-Content $manifestPath | ConvertFrom-Json
              $manifest.version_number = "$env:GitVersion_MajorMinorPatch"
              $manifest | ConvertTo-Json -Depth 10 | Set-Content $manifestPath
              Write-Host "Updated manifest.json version to $env:GitVersion_MajorMinorPatch"
          }

      - name: Create Thunderstore ZIP
        shell: pwsh
        run: |
          $thunderstoreDir = "gallery/thunderstore"
          $zipName = "valheim.foresight.zip"
          
          if (Test-Path $thunderstoreDir) {
              Compress-Archive -Path "$thunderstoreDir/*" -DestinationPath $zipName -Force
              Write-Host "Created $zipName"
          }

      - name: Upload Thunderstore package
        uses: actions/upload-artifact@v4
        with:
          name: thunderstore-package-${{ steps.gitversion.outputs.semVer }}
          path: valheim.foresight.zip
          if-no-files-found: error

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            valheim.foresight.zip
          body: |
            Release ${{ steps.gitversion.outputs.semVer }}
            
            ## Changes
            See CHANGELOG.md for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-thunderstore:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.publish_package == 'true' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: thunderstore-package-*
          merge-multiple: true

      - name: Publish to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.1
        with:
          community: valheim
          namespace: CoffeeNova
          name: Valheim.Foresight
          description: Mod description from manifest.json
          version: ${{ needs.build.outputs.version }}
          token: ${{ secrets.THUNDERSTORE_TOKEN }}
          file: valheim.foresight.zip
          wrap: false
          repo: https://thunderstore.io
          categories: |
            Mods
            Tweaks
